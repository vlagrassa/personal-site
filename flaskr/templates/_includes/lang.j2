{%- macro set_lang(l) -%}
lang="{{l}}" data-lang="{{l}}"{% if lang and lang != l %} class="hide"{% endif %}
{%- endmacro -%}


{% macro render_lang_select_button(l) %}
<button id="button-{{l.code}}" class="lang-button" lang="{{l.code}}" onclick="set_language('{{l.code}}')">
  <div>{{l.name}}</div>
</button>
{% endmacro %}


{% macro render_searchbar_label(id, label) %}
  {% if label is mapping %}
    <label for="{{id}}">
    {% for l, t in label.items() %}
      <span {{ set_lang(l) }}>{{ t }}</span>
    {% endfor %}
    </label>
  {% elif label %}
    <label for="{{id}}">{{label}}</label>
  {% endif %}
{% endmacro %}


{% macro render_searchbar(id=none, oninput=none, label=none, class='') %}
  <div class="searchbar-container {{class}}">
    <input
      id="{{id}}"
      type="text"
      title=""
      required
      {% if oninput %}oninput="{{ oninput }}(this.value)"{% endif %}
    >
    {{ render_searchbar_label(id, label) }}
  </div>
{% endmacro %}


{% macro render_searchbar_tags(id=none, oninput=none, label=none, class='', tags=none) %}
  <div class="searchbar-container {{class}}">
    <div id="{{id}}-searchbar" class="searchbar searchbar-tags">
      {# Tags are added here #}
      <input id="{{id}}" type="text" class="input-tags" oninput="filter_tags(this.value)">
    </div>
    {{ render_searchbar_label(id, label) }}
  </div>

  <div id="search-options-{{id}}" class="collapse multi-collapse" style="transform: translateY(-3px);">
    <div class="card rounded-top-0">
      <div class="card-body">
        <div class="text-start d-flex flex-wrap align-items-center" style="gap: 3px;">
          {% for tag in tags %}
            <button id="{{id}}-tag-{{tag.id}}" class="btn badge btn-custom" onclick="add_tag('{{ tag.id }}');">
              <span {{set_lang("en")}}>{{ tag.name_en }}</span>
              <span {{set_lang("ja")}}>{{ tag.name_ja }}</span>
              <span {{set_lang("tj")}}>{{ tag.name_tj }}</span>
            </button>
          {% endfor %}
        </div>
        <button class="btn badge btn-clear w-100 mt-2" aria-label="Clear" onclick="remove_tag()">Clear</button>
      </div>
    </div>
  </div>

  <script>
    let input_el = document.getElementById('{{id}}');
    input_el.parentElement.parentElement.appendChild(document.getElementById('search-options-{{id}}'));

    input_el.setAttribute('data-bs-toggle', 'collapse')
    input_el.setAttribute('data-bs-target', "#search-options-{{id}}")

    let tag_selection = [];

    function add_tag(tag) {
      tag_selection.push(tag);
      {{ oninput }}(tag_selection);

      const parentElement = document.getElementById('{{id}}-searchbar');
      const buttonElement = document.getElementById(`{{id}}-tag-${tag}`);
      parentElement.insertBefore(buttonElement, parentElement.childNodes[parentElement.childNodes.length - 2]);
      buttonElement.setAttribute('onclick', buttonElement.getAttribute('onclick').replace('add_tag', 'remove_tag'))
    }

    function remove_tag(tag) {
      if (tag) {
        tag_selection = tag_selection.filter((val) => val !== tag);
      }
      else {
        tag_selection = [];
      }
      {{ oninput }}(tag_selection);

      const parentElement = document.getElementById('search-options-{{id}}').children[0].children[0].children[0];
      const buttonElement = document.getElementById(`{{id}}-tag-${tag}`);
      parentElement.appendChild(buttonElement);
      buttonElement.setAttribute('onclick', buttonElement.getAttribute('onclick').replace('remove_tag', 'add_tag'))
    }

    function filter_tags(t) {
      console.log(t);
    }
  </script>
{% endmacro %}
